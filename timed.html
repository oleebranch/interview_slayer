<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timed Challenge</title>
  <style>
    :root {
      --bg: #111315;
      --panel: #1b1f23;
      --text: #e6e6e6;
      --muted: #a9b1ba;
      --accent: #ffc600;
      --good: #2ea043;
      --bad: #e5534b
    }

    * {
      box-sizing: border-box
    }

    /* Base page */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
    }

    /* Fixed back link (stays in corner) */
    a.back {
      position: fixed;
      top: 12px;
      left: 12px;
      text-decoration: none;
      color: var(--accent);
      font-size: 1.05rem;
      z-index: 10;
    }

    /* Center everything else */
    .stage {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: 24px 16px 56px;
      /* room for small screens */
      text-align: center;
    }

    .stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px
    }

    h1 {
      margin: 8px 0 6px;
      font-size: 1.8rem;
      color: var(--accent);
    }

    p.subtitle {
      margin: 0 0 20px;
      color: var(--muted)
    }

    /* Card */
    .arena {
      width: 100%;
      max-width: 760px;
      background: var(--panel);
      border: 1px solid #2a2f35;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .25);
      text-align: left;
      /* inner content left-aligned */
    }

    /* Quiz internals (unchanged) */
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px
    }

    .badge {
      font-size: .9rem;
      color: var(--muted)
    }

    .timer {
      position: relative;
      height: 10px;
      background: #2a2f35;
      border-radius: 999px;
      overflow: hidden;
      margin: 8px 0 16px
    }

    .timer>.bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background: linear-gradient(90deg, var(--good), #f39c12, var(--bad));
      width: 100%;
      transition: width .2s linear
    }

    .question {
      font-size: 1.25rem;
      line-height: 1.35;
      margin: 6px 0 14px
    }

    .options {
      display: grid;
      gap: 10px
    }

    .btn {
      width: 100%;
      text-align: left;
      background: #23282e;
      color: var(--text);
      border: 1px solid #2f3640;
      padding: 12px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem
    }

    .btn:hover {
      background: #2a3139
    }

    .btn.correct {
      background: rgba(46, 160, 67, .18);
      border-color: var(--good)
    }

    .btn.wrong {
      background: rgba(229, 83, 75, .18);
      border-color: var(--bad)
    }

    .feedback {
      margin: 10px 2px;
      color: var(--muted);
      min-height: 22px
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px
    }

    .ghost {
      opacity: .7
    }

    .cta {
      background: var(--accent);
      color: #111;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer
    }

    .cta.secondary {
      background: #1a1a1a;
      color: #ffcc00;
      border: 1px solid #3a4048
    }

    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px
    }

    /* If the viewport is very short, allow content to start a bit higher */
    @media (max-height:640px) {
      .stage {
        align-content: start;
        padding-top: 64px
      }
    }
  </style>
</head>

<body>
  <a href="index.html" class="back">‚¨Ö Back</a>

  <main class="stage">
    <div class="stack">
      <h1>‚è±Ô∏è Timed Challenge</h1>
      <p class="subtitle">You've got the skills ‚Äî now beat the clock. Every second counts.</p>

      <div class="arena" id="arena">
        <div class="center" id="startScreen">
          <p class="ghost">10 questions ¬∑ 20s per question ¬∑ +10 XP per correct</p>
          <button class="cta" id="startBtn">üéÆ Start Challenge</button>
        </div>

        <div id="quiz" style="display:none">
          <div class="row">
            <div class="badge">Question <span id="qNum">1</span>/10</div>
            <div class="badge">‚è≥ <span id="timeLeft">20</span>s</div>
          </div>
          <div class="timer">
            <div class="bar" id="bar"></div>
          </div>
          <div class="question" id="question">Loading‚Ä¶</div>
          <div class="options" id="options"></div>
          <div class="feedback" id="feedback"></div>
          <div class="footer">
            <div class="badge">XP this run: <span id="xpRun">0</span></div>
            <button class="cta secondary" id="skipBtn">Skip</button>
          </div>
        </div>

        <div id="end" style="display:none">
          <div class="center">
            <h2>Well played, legend. ‚öîÔ∏è</h2>
            <p class="ghost">Accuracy: <span id="accPct">0</span>% ¬∑ Time used: <span id="timeUsed">0</span>s</p>
            <p>XP earned: <strong><span id="xpEarned">0</span></strong></p>
            <div style="display:flex;gap:10px">
              <button class="cta" id="playAgain">Play Again</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>


  <script>
    /* -------------------- CONFIG -------------------- */
    const BANK_URL = 'timed_quiz.json';  // sits next to timed.html
    const PER_Q = 20;                 // seconds per question
    const TOTAL_Q = 10;                 // questions per run
    const XP_CORRECT = 10;                 // XP per correct answer
    const BAG_KEY = 'timed_bag_v1';     // rotation state
    const XP_KEY = 'xp';               // cumulative XP storage

    /* -------------------- ELEMENTS -------------------- */
    const els = {
      start: document.getElementById('startScreen'),
      startBtn: document.getElementById('startBtn'),
      quiz: document.getElementById('quiz'),
      qNum: document.getElementById('qNum'),
      timeLeft: document.getElementById('timeLeft'),
      bar: document.getElementById('bar'),
      question: document.getElementById('question'),
      options: document.getElementById('options'),
      feedback: document.getElementById('feedback'),
      xpRun: document.getElementById('xpRun'),
      skipBtn: document.getElementById('skipBtn'),
      end: document.getElementById('end'),
      accPct: document.getElementById('accPct'),
      timeUsed: document.getElementById('timeUsed'),
      xpEarned: document.getElementById('xpEarned'),
      playAgain: document.getElementById('playAgain'),
      arena: document.getElementById('arena')
    };

    /* -------------------- STATE -------------------- */
    let bank = [];         // full question bank
    let bag = [];         // rotating shuffled indices (persisted)
    let deck = [];         // current run's questions (objects)
    let idx = 0;           // pointer into deck
    let correct = 0;
    let xpThisRun = 0;
    let usedSeconds = 0;
    let ticking = null;
    let secs = PER_Q;
    let misses = [];       // [{q, chosen, correct, tip}...]

    /* -------------------- UTILS -------------------- */
    function fyShuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function saveBag() {
      localStorage.setItem(BAG_KEY, JSON.stringify(bag));
    }

    function loadBag(expectedLen) {
      try {
        const raw = localStorage.getItem(BAG_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if (Array.isArray(parsed) && parsed.every(n => Number.isInteger(n))) {
          // If bank size changed, reset the bag
          const unique = [...new Set(parsed)].filter(i => i >= 0 && i < expectedLen);
          if (unique.length) return unique;
        }
      } catch { }
      return null;
    }

    /* -------------------- DATA LOAD -------------------- */
    const fallback = [
      {
        question: "What does MVP stand for in product development?",
        options: ["Most Valuable Product", "Minimum Viable Product", "Model Validation Process", "Market Viability Plan"],
        answer: "Minimum Viable Product",
        tip: "Smallest thing that still delivers value."
      },
      {
        question: "Which methodology uses sprints and stand-ups?",
        options: ["Waterfall", "Agile", "Kanban", "PRINCE2"],
        answer: "Agile",
        tip: "Iterative, collaborative, quick feedback."
      }
    ];

    async function loadBank() {
      try {
        const res = await fetch(BANK_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();

        // Keep only clean, valid items
        bank = data.filter(q =>
          q && typeof q.question === 'string' &&
          Array.isArray(q.options) && q.options.length >= 2 &&
          (q.answer || q.correctAnswer)
        ).map(q => ({
          question: q.question.trim(),
          options: q.options.slice(),
          answer: (q.answer || q.correctAnswer).toString().trim(),
          tip: (q.tip || q.explanation || '').toString().trim()
        }));

        if (!bank.length) throw new Error('Empty bank');

        // init/restore the rotation bag
        bag = loadBag(bank.length);
        if (!bag || bag.length === 0) {
          bag = fyShuffle([...Array(bank.length).keys()]);
          saveBag();
        }
      } catch (e) {
        console.warn('Using fallback questions due to load error:', e);
        bank = fallback;
        bag = fyShuffle([...Array(bank.length).keys()]);
        saveBag();
      }
    }

    /* -------------------- GAME FLOW -------------------- */
    function takeFromBag(n) {
      // if not enough items left, reshuffle a fresh full bag
      if (bag.length < n) {
        bag = fyShuffle([...Array(bank.length).keys()]);
      }
      const pickedIdxs = bag.splice(0, n);
      saveBag();
      return pickedIdxs.map(i => bank[i]);
    }

    function start() {
      // reset run state
      idx = 0; correct = 0; xpThisRun = 0; usedSeconds = 0; secs = PER_Q;
      misses = [];
      deck = takeFromBag(Math.min(TOTAL_Q, bank.length));

      // switch screens
      els.start.style.display = 'none';
      els.end.style.display = 'none';
      els.quiz.style.display = 'block';
      els.feedback.textContent = '';
      els.xpRun.textContent = xpThisRun;

      next();
    }

    function next() {
      clearInterval(ticking);
      if (idx >= deck.length) { finish(); return; }

      secs = PER_Q;
      els.qNum.textContent = idx + 1;
      els.timeLeft.textContent = secs;
      els.bar.style.width = '100%';

      // render Q
      const q = deck[idx];
      els.question.textContent = q.question;
      els.options.innerHTML = '';
      fyShuffle(q.options.slice()).forEach(opt => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = opt;
        b.onclick = () => choose(opt);
        els.options.appendChild(b);
      });

      // timer
      ticking = setInterval(() => {
        secs--; usedSeconds++;
        els.timeLeft.textContent = Math.max(0, secs);
        els.bar.style.width = (secs / PER_Q * 100) + '%';
        if (secs <= 0) {
          clearInterval(ticking);
          recordMiss(null);   // time-out counts as miss (no choice)
          // immediately move on (no hint mid-run)
          advance();
        }
      }, 1000);
    }

    function lockOptions() {
      [...els.options.children].forEach(b => b.disabled = true);
    }

    function choose(opt) {
      clearInterval(ticking);
      const q = deck[idx];
      const correctOpt = q.answer;

      lockOptions();

      if (opt === correctOpt) {
        correct++;
        xpThisRun += XP_CORRECT;
        els.xpRun.textContent = xpThisRun;
        // tiny flash on the picked button (optional)
        const picked = [...els.options.children].find(b => b.textContent === opt);
        if (picked) picked.classList.add('correct');
      } else {
        // mark wrong quickly, no hint; review later
        recordMiss(opt);
        const picked = [...els.options.children].find(b => b.textContent === opt);
        if (picked) picked.classList.add('wrong');
      }

      // short pause so the user sees what was selected, then move on
      setTimeout(advance, 220);
    }

    function recordMiss(chosen) {
      const q = deck[idx];
      misses.push({
        question: q.question,
        chosen: chosen === null ? '(timeout)' : (chosen ?? '(skipped)'),
        correct: q.answer,
        tip: q.tip || ''
      });
    }

    function advance() {
      idx++;
      next();
    }

    els.skipBtn.addEventListener('click', () => {
      clearInterval(ticking);
      lockOptions();
      recordMiss('(skipped)');
      setTimeout(advance, 120);
    });

    /* -------------------- END / REVIEW -------------------- */
    function finish() {
      clearInterval(ticking);
      els.quiz.style.display = 'none';
      els.end.style.display = 'block';

      const acc = Math.round((correct / deck.length) * 100);
      els.accPct.textContent = acc;
      els.timeUsed.textContent = usedSeconds;
      els.xpEarned.textContent = xpThisRun;

      // persist cumulative XP
      const total = Number(localStorage.getItem(XP_KEY) || 0) + xpThisRun;
      localStorage.setItem(XP_KEY, String(total));

      // build review (misses only)
      buildReview();
    }

    function buildReview() {
      // remove prior review block if exists
      const old = document.getElementById('review');
      if (old) old.remove();

      const wrap = document.createElement('div');
      wrap.id = 'review';
      wrap.style.marginTop = '16px';

      if (misses.length === 0) {
        const p = document.createElement('p');
        p.className = 'ghost';
        p.textContent = 'Flawless victory. No misses to review. ‚ú®';
        wrap.appendChild(p);
      } else {
        const details = document.createElement('details');
        details.open = true;

        const summary = document.createElement('summary');
        summary.textContent = `Review missed questions (${misses.length})`;
        summary.style.cursor = 'pointer';
        summary.style.marginBottom = '10px';
        details.appendChild(summary);

        const list = document.createElement('div');
        list.style.display = 'grid';
        list.style.gap = '10px';

        misses.forEach(m => {
          const card = document.createElement('div');
          card.style.border = '1px solid #2a2f35';
          card.style.borderRadius = '10px';
          card.style.padding = '10px';
          card.style.background = '#23282e';

          const q = document.createElement('div');
          q.style.fontWeight = '700';
          q.style.marginBottom = '6px';
          q.textContent = m.question;

          const your = document.createElement('div');
          your.innerHTML = `<span class="ghost">Your answer:</span> ${m.chosen}`;

          const corr = document.createElement('div');
          corr.innerHTML = `<span class="ghost">Correct:</span> ${m.correct}`;

          card.appendChild(q);
          card.appendChild(your);
          card.appendChild(corr);

          if (m.tip) {
            const tip = document.createElement('div');
            tip.className = 'ghost';
            tip.style.marginTop = '4px';
            tip.textContent = `Tip: ${m.tip}`;
            card.appendChild(tip);
          }

          list.appendChild(card);
        });

        details.appendChild(list);
        wrap.appendChild(details);
      }

      els.end.querySelector('.center').appendChild(wrap);
    }

    /* -------------------- PLAY AGAIN -------------------- */
    els.playAgain.addEventListener('click', start);

    /* -------------------- START BUTTON / BOOT -------------------- */
    els.startBtn.disabled = true;
    els.startBtn.addEventListener('click', start);

    (async function boot() {
      await loadBank();
      els.startBtn.disabled = false; // ready to go
    })();
  </script>

</body>

</html>