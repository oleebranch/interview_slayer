<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#121212">

  <title>üéØ Slay Mode - Quiz Arena</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      height: 100%;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    html,
    body,
    #appRoot {
      height: 100%;
    }

    #appRoot {
      min-height: 100dvh;
      /* dynamic viewport height (best on mobile) */
      min-height: 100svh;
      /* small viewport height fallback */
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .app-header {
      background: #0b0b12;
      /* same dark color */
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: calc(8px + env(safe-area-inset-top, 0px)) 12px 8px 12px;
    }

    #fs-btn {
      display: none;
    }

    .fullbleed {
      block-size: 100dvh;
      inline-size: 100%;
      overflow: hidden;
    }

    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      max-width: 800px;
      width: 100%;
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #333;
    }

    .question {
      font-size: 2em;
      color: #ffcc00;
      margin-top: 3rem;
      margin-bottom: 15px;
    }

    .option {
      display: block;
      background-color: #2a2a2a;
      color: white;
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      text-align: left;
    }

    .option:hover {
      background-color: #333;
    }

    .feedback {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
    }

    .correct {
      background-color: #2e7d32;
    }

    .wrong {
      background-color: #c62828;
    }

    .xp {
      margin-top: 20px;
      font-weight: bold;
      color: #ffcc00;
    }

    .back-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #ffcc00;
      ;
      text-decoration: none;
      font-size: 1.2rem;
    }
  </style>
</head>

<body>
  <a class="back-btn" href="solo.html">‚¨Ö Back</a>

  <div class="app">
    <header class="app-header">
      <button id="fs-btn" aria-pressed="false" title="Toggle Fullscreen"></button>
    </header>
  </div>

  <div class="container">
    <div id="question-box">
      <div class="question" id="question-text"></div>
      <div id="options-container"></div>
    </div>
    <div class="feedback" id="feedback-box"></div>
    <div class="xp" id="xp-display">XP: 0</div>
  </div>

  <script>
    const XP_PER = 10;

    // --- DOM ---------------------------------------------------------------
    const els = {
      q: document.getElementById("question-text"),
      opts: document.getElementById("options-container"),
      fb: document.getElementById("feedback-box"),
      xp: document.getElementById("xp-display"),
    };

    // --- STATE -------------------------------------------------------------
    let bank = [];            // full question bank (normalized)
    let order = [];           // shuffled indices through bank
    let idx = 0;              // pointer into order
    let xp = Number(localStorage.getItem("pm_xp") || 0);

    // Fisher‚ÄìYates shuffle
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    async function loadBank() {
      try {
        const res = await fetch("pm_quiz.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Network error");
        const raw = await res.json();

        // normalize: ensure fields -> question, options, answer, explanation
        bank = raw.map(item => ({
          question: item.question || item.prompt || "",
          options: (item.options || item.choices || []).slice(0),
          answer: item.answer || item.correct_answer || item.correctAnswer || "",
          explanation:
            item.explanation ||
            item.tip ||
            item.explanation_correct ||
            "",
          explanation_wrong: item.explanation_wrong || null
        })).filter(q =>
          q.question && Array.isArray(q.options) && q.options.length >= 2 && q.answer
        );

        // set first run order
        order = shuffle([...Array(bank.length).keys()]);
        idx = 0;

        // paint XP and first question
        els.xp.textContent = `XP: ${xp}`;
        showQuestion();
      } catch (e) {
        els.q.textContent = "Could not load pm_quiz.json üòï";
      }
    }

    function showQuestion() {
      const q = bank[order[idx]];
      els.q.textContent = q.question;
      els.fb.innerHTML = "";
      els.opts.innerHTML = "";

      // shuffle options each time
      const opts = shuffle([...q.options]);

      opts.forEach(opt => {
        const b = document.createElement("button");
        b.className = "option";
        b.type = "button";
        b.textContent = opt;
        b.addEventListener("click", () => checkAnswer(opt, q, b));
        els.opts.appendChild(b);
      });
    }

    function lockOptions() {
      [...els.opts.querySelectorAll("button")].forEach(b => b.disabled = true);
    }

    function checkAnswer(selected, q, btn) {
      lockOptions();

      const correct = q.answer;
      const isCorrect = selected === correct;

      if (isCorrect) {
        btn.classList.add("correct");
        xp += XP_PER;
        els.fb.innerHTML = `<div class="feedback correct">‚úÖ Correct! +${XP_PER} XP${q.explanation ? " ‚Äî " + q.explanation : ""}</div>`;
        els.xp.textContent = `XP: ${xp}`;
        localStorage.setItem("pm_xp", String(xp));
      } else {
        btn.classList.add("wrong");
        // highlight correct choice
        const btns = [...els.opts.querySelectorAll("button")];
        const correctBtn = btns.find(b => b.textContent === correct);
        if (correctBtn) correctBtn.classList.add("correct");

        // tailored wrong explanation if provided
        const reason = (q.explanation_wrong && q.explanation_wrong[selected]) ? ` ${q.explanation_wrong[selected]}` : "";
        els.fb.innerHTML = `<div class="feedback wrong">‚ùå Not quite.${reason} The correct answer is <strong>${correct}</strong>. ${q.explanation || ""}</div>`;
      }

      // move on after a short pause
      setTimeout(next, 5000);
    }

    function next() {
      idx++;
      if (idx >= order.length) {
        // you‚Äôve seen them all ‚Äî reshuffle for endless practice
        order = shuffle(order);
        idx = 0;
      }
      showQuestion();
    }

    // boot
    loadBank();
  </script>

</body>

</html>